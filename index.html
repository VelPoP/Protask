<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ProTask Elite</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <style>
        :root {
            --md-primary: #0061A4; --md-on-primary: #ffffff; --md-surface: #FDFCFF;
            --md-surface-variant: #E0E2EC; --md-on-surface: #1A1C1E; --md-outline: #74777F;
            --md-error: #BA1A1A; --md-success: #198754;
            --priority-high: #BA1A1A; --priority-med: #E28100; --priority-low: #198754;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--md-surface); margin: 0; padding: 16px; padding-bottom: 450px; color: var(--md-on-surface); }
        header { display: flex; flex-direction: column; gap: 8px; padding: 12px 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        #tokenBox { display: none; font-size: 10px; background: #f0f4f9; border: 1px dashed var(--md-outline); padding: 10px; border-radius: 12px; word-break: break-all; margin-bottom: 10px; color: var(--md-primary); }
        .progress-track { height: 10px; background: var(--md-surface-variant); border-radius: 10px; margin: 16px 0; overflow: hidden; }
        #progressBar { height: 100%; background: var(--md-primary); width: 0%; transition: width 0.6s; }
        .task-card { background: #f0f4f9; border-radius: 20px; padding: 16px; margin-bottom: 12px; display: flex; flex-direction: column; border-left: 6px solid transparent; }
        .task-card.p-high { border-left-color: var(--priority-high); }
        .task-card.p-med { border-left-color: var(--priority-med); }
        .task-card.p-low { border-left-color: var(--priority-low); }
        .task-main { display: flex; align-items: center; gap: 12px; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 32px 32px 0 0; padding: 20px; box-shadow: 0 -8px 32px rgba(0,0,0,0.1); z-index: 100; }
        .input-group { background: #f0f4f9; border-radius: 16px; padding: 8px 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
        input[type="text"] { background: none; border: none; width: 100%; height: 40px; font-size: 16px; outline: none; flex: 1; }
        .save-btn { background: var(--md-primary); color: white; border: none; width: 100%; height: 56px; border-radius: 28px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-icon { background: none; border: none; color: var(--md-outline); cursor: pointer; padding: 8px; }
        .priority-pill { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; border: 1px solid var(--md-outline); background: white; }
        .priority-pill.active[data-p="low"] { background: var(--priority-low); color: white; border-color: var(--priority-low); }
        .priority-pill.active[data-p="med"] { background: var(--priority-med); color: white; border-color: var(--priority-med); }
        .priority-pill.active[data-p="high"] { background: var(--priority-high); color: white; border-color: var(--priority-high); }
        .done { opacity: 0.4; filter: grayscale(1); }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>ProTask Elite</h1>
        <div style="display:flex; gap: 4px;">
            <button class="btn-icon" onclick="fullReset()"><span class="material-symbols-outlined" style="color:var(--md-error)">delete_forever</span></button>
            <button class="btn-icon" onclick="initNotifications()" id="bellBtn"><span class="material-symbols-outlined">notifications</span></button>
        </div>
    </div>
    <div id="tokenBox">Getting phone key...</div>
</header>

<div class="progress-track"><div id="progressBar"></div></div>
<div id="list"></div>

<div class="bottom-sheet">
    <div class="input-group">
        <button class="btn-icon" onclick="startVoice()"><span class="material-symbols-outlined" style="color:var(--md-primary)">mic</span></button>
        <input type="text" id="tTitle" placeholder="Task description...">
    </div>
    <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center;">
        <div class="priority-pill active" data-p="low" onclick="setPriority('low')">Low</div>
        <div class="priority-pill" data-p="med" onclick="setPriority('med')">Med</div>
        <div class="priority-pill" data-p="high" onclick="setPriority('high')">High</div>
    </div>
    <input type="date" id="tDate" style="width:100%; padding:12px; border-radius:16px; background:#f0f4f9; border:none; margin-bottom:12px;">
    <button class="save-btn" onclick="saveTask()">Schedule Task</button>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB1u-t7oQLWDg333noZcmtscbOo8fftPYE",
        authDomain: "protask-97ac8.firebaseapp.com",
        projectId: "protask-97ac8",
        storageBucket: "protask-97ac8.firebasestorage.app",
        messagingSenderId: "18921043127",
        appId: "1:18921043127:web:7780ee8e5b7ce919684932"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    let tasks = JSON.parse(localStorage.getItem('pro_elite_final')) || [];
    let selectedPriority = 'low';

    if ('serviceWorker' in navigator) { 
        navigator.serviceWorker.register('sw.js');
    }

    function initNotifications() {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                document.getElementById('bellBtn').style.color = 'var(--md-success)';
                navigator.serviceWorker.ready.then((reg) => {
                    messaging.getToken({ 
                        vapidKey: 'BCVagHMWKomUbaoQdNy-vHYAhl22WsRT9jg-dKabIgtCWQaFVJN966m6wYMPrM0v8y3T5Khk6XmCkv5YDz4vxKI',
                        serviceWorkerRegistration: reg 
                    })
                    .then((token) => {
                        if (token) {
                            const box = document.getElementById('tokenBox');
                            box.style.display = 'block';
                            box.innerText = "YOUR PHONE KEY: " + token;
                        }
                    });
                });
            }
        });
    }

    function saveTask() {
        const title = document.getElementById('tTitle').value;
        const date = document.getElementById('tDate').value;
        if(!title) return;
        tasks.push({ id: Date.now(), title, time: date, priority: selectedPriority, done: false, notified: false });
        document.getElementById('tTitle').value = "";
        render();
    }

    function render() {
        localStorage.setItem('pro_elite_final', JSON.stringify(tasks));
        const list = document.getElementById('list');
        list.innerHTML = "";
        tasks.forEach(t => {
            list.innerHTML += `
                <div class="task-card p-${t.priority} ${t.done ? 'done' : ''}">
                    <div class="task-main">
                        <div style="flex:1">
                            <b>${t.title}</b><br><small>${t.time}</small>
                        </div>
                        <button class="btn-icon" onclick="del(${t.id})"><span class="material-symbols-outlined">delete</span></button>
                    </div>
                </div>`;
        });
        const completed = tasks.filter(t => t.done).length;
        document.getElementById('progressBar').style.width = (tasks.length ? (completed/tasks.length)*100 : 0) + '%';
    }

    function del(id) { tasks = tasks.filter(x => x.id !== id); render(); }
    function setPriority(p) { selectedPriority = p; document.querySelectorAll('.priority-pill').forEach(el => el.classList.toggle('active', el.dataset.p === p)); }
    function fullReset() { if(confirm("Clear all?")) { tasks = []; localStorage.removeItem('pro_elite_final'); render(); } }

    function startVoice() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return alert("Not supported.");
        const rec = new SpeechRecognition();
        rec.onresult = (e) => { document.getElementById('tTitle').value = e.results[0][0].transcript; };
        rec.start();
    }

    // Check for notifications every 15 seconds [cite: 67]
    setInterval(() => {
        const now = new Date().toISOString().split('T')[0];
        tasks.forEach(t => {
            if (!t.done && t.time === now && !t.notified) {
                t.notified = true;
                document.getElementById('beep').play();
                if (Notification.permission === "granted" && 'serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(reg => {
                        reg.active.postMessage({ type: 'SHOW_NOTIFICATION', title: "Task Due!", body: t.title });
                    });
                }
                render();
            }
        });
    }, 15000);

    window.onload = () => {
        document.getElementById('tDate').value = new Date().toISOString().split('T')[0];
        render();
    };
</script>
</body>
</html>