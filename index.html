<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ProTask Elite</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />
    <style>
        :root {
            --md-primary: #0061A4;
            --md-on-primary: #ffffff;
            --md-surface: #FDFCFF;
            --md-surface-variant: #E0E2EC;
            --md-on-surface: #1A1C1E;
            --md-outline: #74777F;
            --md-error: #BA1A1A;
            --md-success: #198754;
            --priority-high: #BA1A1A;
            --priority-med: #E28100;
            --priority-low: #198754;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--md-surface);
            margin: 0; padding: 16px; padding-bottom: 480px;
            color: var(--md-on-surface);
        }

        header { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
        h1 { font-size: 28px; font-weight: 400; margin: 0; letter-spacing: -0.5px; }

        .progress-track { height: 12px; background: var(--md-surface-variant); border-radius: 10px; margin: 16px 0; overflow: hidden; }
        #progressBar { height: 100%; background: var(--md-primary); width: 0%; transition: width 0.6s; }

        .task-card {
            background: #f0f4f9; border-radius: 20px; padding: 16px; margin-bottom: 12px;
            display: flex; flex-direction: column; border-left: 6px solid transparent;
            cursor: grab; transition: transform 0.1s;
        }
        .task-card.dragging { opacity: 0.5; border: 2px dashed var(--md-primary); }
        .task-card.p-high { border-left-color: var(--priority-high); }
        .task-card.p-med { border-left-color: var(--priority-med); }
        .task-card.p-low { border-left-color: var(--priority-low); }

        .task-main { display: flex; align-items: center; gap: 12px; }
        .check-circle { width: 28px; height: 28px; border: 2px solid var(--md-outline); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .check-circle.checked { background: var(--md-success); border-color: var(--md-success); color: white; }
        
        .task-info { flex-grow: 1; }
        .task-title { font-size: 16px; font-weight: 600; }
        .task-time { font-size: 13px; color: var(--md-primary); font-weight: 600; }

        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 32px 32px 0 0; padding: 20px; box-shadow: 0 -8px 32px rgba(0,0,0,0.1); z-index: 100; }
        .suggestions-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; scrollbar-width: none; }
        .slot-chip { background: #D1E4FF; color: #001D36; padding: 8px 16px; border-radius: 16px; font-size: 12px; font-weight: 600; border: none; white-space: nowrap; }

        .input-group { background: #f0f4f9; border-radius: 16px; padding: 8px 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
        input[type="text"] { background: none; border: none; width: 100%; height: 40px; font-size: 16px; outline: none; }
        
        .priority-pill { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; border: 1px solid var(--md-outline); background: white; }
        .priority-pill.active[data-p="high"] { background: var(--priority-high); color: white; border-color: var(--priority-high); }
        .priority-pill.active[data-p="med"] { background: var(--priority-med); color: white; border-color: var(--priority-med); }
        .priority-pill.active[data-p="low"] { background: var(--priority-low); color: white; border-color: var(--priority-low); }

        .save-btn { background: var(--md-primary); color: white; border: none; width: 100%; height: 56px; border-radius: 28px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px; }
        .btn-icon { background: none; border: none; color: var(--md-outline); cursor: pointer; padding: 8px; border-radius: 50%; }
        .done { opacity: 0.4; filter: grayscale(1); }
        
        .quick-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.05); }
        .q-btn { flex: 1; background: white; border: 1px solid var(--md-surface-variant); border-radius: 12px; padding: 8px; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 4px; }
    </style>
</head>
<body>

<header>
    <h1>ProTask</h1>
    <div style="display:flex; gap: 4px;">
        <button class="btn-icon" onclick="reqNotifications()" id="bellBtn"><span class="material-symbols-outlined">notifications</span></button>
        <button class="btn-icon" onclick="exportJSON()"><span class="material-symbols-outlined">download</span></button>
        <button class="btn-icon" onclick="document.getElementById('importFile').click()"><span class="material-symbols-outlined">upload</span></button>
        <button class="btn-icon" onclick="snoozeAll()"><span class="material-symbols-outlined">forward_30</span></button>
        <button class="btn-icon" onclick="clearAll()" style="color:var(--md-error)"><span class="material-symbols-outlined">delete_sweep</span></button>
    </div>
</header>

<input type="file" id="importFile" style="display:none" accept=".json" onchange="importJSON(event)">
<div class="progress-track"><div id="progressBar"></div></div>
<div id="list"></div>

<div class="bottom-sheet">
    <div class="suggestions-row" id="suggestions"></div>
    <div class="input-group">
        <button class="btn-icon" id="voiceBtn" onclick="startVoice()"><span class="material-symbols-outlined" style="color:var(--md-primary)">mic</span></button>
        <input type="text" id="tTitle" placeholder="What's next?">
    </div>

    <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center;">
        <span style="font-size:11px; font-weight:bold; color:var(--md-outline)">PRIORITY:</span>
        <div class="priority-pill active" data-p="low" onclick="setPriority('low')">Low</div>
        <div class="priority-pill" data-p="med" onclick="setPriority('med')">Med</div>
        <div class="priority-pill" data-p="high" onclick="setPriority('high')">High</div>
    </div>

    <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input type="date" id="tDate" style="background:#f0f4f9; border:none; padding:12px; border-radius:16px; flex:1;">
        <div style="display:flex; align-items:center; background:#f0f4f9; padding:0 12px; border-radius:16px;">
            <input type="number" id="tHour" style="width:35px; border:none; background:none; font-weight:bold; text-align:center;" value="12">
            <b>:</b>
            <input type="number" id="tMin" style="width:35px; border:none; background:none; font-weight:bold; text-align:center;" value="00">
            <select id="tPeriod" style="border:none; background:none; font-weight:bold; color:var(--md-primary)">
                <option>AM</option><option>PM</option>
            </select>
        </div>
    </div>

    <button class="save-btn" onclick="saveTask()">
        <span class="material-symbols-outlined" id="btnIcon">add</span>
        <span id="btnText">Schedule Task</span>
    </button>
</div>

<audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    let tasks = JSON.parse(localStorage.getItem('pro_elite_v5')) || [];
    let editId = null;
    let selectedPriority = 'low';
    const formatter = new Intl.DateTimeFormat('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

    function toLocalISO(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    // --- CORE SAVE ---
    function saveTask() {
        const title = document.getElementById('tTitle').value;
        if(!title) return;

        const dateVal = document.getElementById('tDate').value;
        let h = parseInt(document.getElementById('tHour').value);
        const m = document.getElementById('tMin').value.padStart(2, '0');
        const p = document.getElementById('tPeriod').value;

        if (p === "PM" && h < 12) h += 12;
        if (p === "AM" && h === 12) h = 0;
        const fullTime = `${dateVal}T${String(h).padStart(2, '0')}:${m}`;

        // Conflict Alert
        const conflict = tasks.find(t => t.time === fullTime && t.id !== editId && !t.done);
        if(conflict && !confirm(`CONFLICT: "${conflict.title}" already scheduled. Continue?`)) return;

        if(editId) {
            const idx = tasks.findIndex(t => t.id === editId);
            tasks[idx] = { ...tasks[idx], title, time: fullTime, priority: selectedPriority };
            editId = null;
            document.getElementById('btnText').innerText = "Schedule Task";
        } else {
            tasks.push({ id: Date.now(), title, time: fullTime, priority: selectedPriority, done: false, notified: false });
        }
        
        document.getElementById('tTitle').value = "";
        render();
    }

    function render() {
        // AUTO ASSORT WORK AS PER TIME
        tasks.sort((a,b) => new Date(a.time) - new Date(b.time));
        localStorage.setItem('pro_elite_v5', JSON.stringify(tasks));
        
        const list = document.getElementById('list');
        list.innerHTML = "";
        
        tasks.forEach(t => {
            const card = document.createElement('div');
            card.className = `task-card p-${t.priority} ${t.done ? 'done' : ''}`;
            card.draggable = !t.done;
            card.dataset.id = t.id;
            
            card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', t.id); });
            card.addEventListener('dragover', (e) => e.preventDefault());
            card.addEventListener('drop', handleDrop);

            card.innerHTML = `
                <div class="task-main">
                    <div class="check-circle ${t.done ? 'checked' : ''}" onclick="toggle(${t.id})"><span class="material-symbols-outlined" style="font-size:18px">check</span></div>
                    <div class="task-info">
                        <div class="task-title">${t.title}</div>
                        <div class="task-time">${formatter.format(new Date(t.time))}</div>
                    </div>
                    <button class="btn-icon" onclick="editTask(${t.id})"><span class="material-symbols-outlined">edit</span></button>
                    <button class="btn-icon" onclick="del(${t.id})"><span class="material-symbols-outlined">delete</span></button>
                </div>
                ${!t.done ? `
                <div class="quick-actions">
                    <button class="q-btn" onclick="finishAndPull(${t.id})"><span class="material-symbols-outlined" style="font-size:14px">bolt</span> Finish</button>
                    <button class="q-btn" onclick="bumperShift(${t.id})"><span class="material-symbols-outlined" style="font-size:14px">schedule</span> Bump</button>
                </div>` : ''}
            `;
            list.appendChild(card);
        });

        const completed = tasks.filter(t => t.done).length;
        document.getElementById('progressBar').style.width = (tasks.length ? (completed/tasks.length)*100 : 0) + '%';
        findGaps();
    }

    // --- BACKGROUND NOTIFICATIONS FIX ---
    function reqNotifications() {
        if (!("Notification" in window)) return alert("Browser does not support notifications.");
        Notification.requestPermission().then(p => {
            if (p === "granted") {
                document.getElementById('bellBtn').style.color = 'var(--md-success)';
                new Notification("Notifications Active", { body: "ProTask will now alert you when tasks are due." });
            }
        });
    }

    // Check for tasks every 30 seconds
    setInterval(() => {
        const now = toLocalISO(new Date()).slice(0, 16);
        tasks.forEach(t => {
            if (!t.done && t.time.slice(0, 16) === now && !t.notified) {
                t.notified = true;
                document.getElementById('alarmSound').play(); // Audible beep
                if (Notification.permission === "granted") {
                    // Try Service Worker notification (Better for background)
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.ready.then(reg => {
                            reg.showNotification("ProTask Due!", { body: t.title });
                        });
                    } else {
                        new Notification("ProTask Due!", { body: t.title });
                    }
                } else {
                    alert("TIME FOR: " + t.title);
                }
            }
        });
    }, 30000);

    // --- VOICE FIX (REQUIRES HTTPS) ---
    function startVoice() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return alert("Speech Recognition not supported.");
        
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            alert("SECURITY ERROR: Voice input requires an HTTPS connection. Please host this file on GitHub Pages or Vercel.");
            return;
        }

        const rec = new SpeechRecognition();
        rec.lang = 'en-US';
        document.getElementById('voiceBtn').style.color = 'red';
        rec.onresult = (e) => { document.getElementById('tTitle').value = e.results[0][0].transcript; };
        rec.onend = () => { document.getElementById('voiceBtn').style.color = 'var(--md-primary)'; };
        rec.onerror = () => { alert("Voice Error: Check permissions or connection."); };
        rec.start();
    }

    // --- IMPORT / EXPORT JSON ---
    function exportJSON() {
        const blob = new Blob([JSON.stringify(tasks, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ProTask_Backup_${new Date().toLocaleDateString()}.json`;
        a.click();
    }

    function importJSON(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                tasks = JSON.parse(e.target.result);
                render();
                alert("Import Successful!");
            } catch(err) { alert("Invalid File."); }
        };
        reader.readAsText(event.target.files[0]);
    }

    // --- SLOTS & TOOLS ---
    function findGaps() {
        const container = document.getElementById('suggestions');
        container.innerHTML = "";
        let checkTime = new Date();
        checkTime.setMinutes(checkTime.getMinutes() < 30 ? 30 : 60, 0, 0);

        for(let i=0; i<6; i++) {
            const timeStr = toLocalISO(checkTime);
            if (!tasks.some(t => !t.done && t.time === timeStr)) {
                const chip = document.createElement('button');
                chip.className = "slot-chip";
                chip.innerText = formatter.format(checkTime);
                chip.onclick = () => {
                    const d = new Date(timeStr);
                    document.getElementById('tHour').value = d.getHours() % 12 || 12;
                    document.getElementById('tMin').value = String(d.getMinutes()).padStart(2, '0');
                    document.getElementById('tPeriod').value = d.getHours() >= 12 ? "PM" : "AM";
                };
                container.appendChild(chip);
            }
            checkTime.setMinutes(checkTime.getMinutes() + 30);
        }
    }

    function handleDrop(e) {
        const dId = e.dataTransfer.getData('text/plain');
        const tId = this.dataset.id;
        if (dId !== tId) {
            const t1 = tasks.find(x => x.id == dId);
            const t2 = tasks.find(x => x.id == tId);
            const temp = t1.time; t1.time = t2.time; t2.time = temp;
            render();
        }
    }

    function editTask(id) {
        const t = tasks.find(x => x.id === id);
        editId = id;
        document.getElementById('tTitle').value = t.title;
        setPriority(t.priority);
        const d = new Date(t.time);
        document.getElementById('tDate').value = t.time.split('T')[0];
        document.getElementById('tHour').value = d.getHours() % 12 || 12;
        document.getElementById('tMin').value = String(d.getMinutes()).padStart(2, '0');
        document.getElementById('tPeriod').value = d.getHours() >= 12 ? "PM" : "AM";
        document.getElementById('btnText').innerText = "Update Task";
    }

    function setPriority(p) { selectedPriority = p; document.querySelectorAll('.priority-pill').forEach(el => el.classList.toggle('active', el.dataset.p === p)); }
    function toggle(id) { tasks.find(x => x.id === id).done = !tasks.find(x => x.id === id).done; render(); }
    function del(id) { tasks = tasks.filter(x => x.id !== id); render(); }
    function clearAll() { if(confirm("Delete all data?")) { tasks = []; render(); }}
    function snoozeAll() { tasks.forEach(t => { if(!t.done){ let d = new Date(t.time); d.setMinutes(d.getMinutes()+30); t.time = toLocalISO(d); }}); render(); }
    function bumperShift(id) {
        const start = new Date(tasks.find(t => t.id === id).time).getTime();
        tasks.forEach(t => { if(!t.done && new Date(t.time).getTime() >= start) {
            let d = new Date(t.time); d.setMinutes(d.getMinutes()+30); t.time = toLocalISO(d);
        }});
        render();
    }
    function finishAndPull(id) {
        tasks.find(t => t.id === id).done = true;
        const next = tasks.filter(t => !t.done).sort((a,b) => new Date(a.time) - new Date(b.time))[0];
        if (next) next.time = toLocalISO(new Date());
        render();
    }

    window.onload = () => {
        document.getElementById('tDate').value = new Date().toISOString().split('T')[0];
        render();
        
        // Register simple Service Worker for background support (only works on HTTPS)
        if ('serviceWorker' in navigator) {
            const sw = 'data:text/javascript;base64,' + btoa('self.addEventListener("push", (e) => { const d = e.data.json(); self.registration.showNotification(d.title, d); });');
            navigator.serviceWorker.register(sw);
        }
    };
</script>
</body>
</html>