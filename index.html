<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ProTask Elite Debug</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <style>
        :root {
            --md-primary: #0061A4; --md-on-primary: #ffffff; --md-surface: #FDFCFF;
            --md-surface-variant: #E0E2EC; --md-on-surface: #1A1C1E; --md-outline: #74777F;
            --md-error: #BA1A1A; --md-success: #198754;
            --priority-high: #BA1A1A; --priority-med: #E28100; --priority-low: #198754;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--md-surface); margin: 0; padding: 16px; padding-bottom: 450px; color: var(--md-on-surface); }
        
        /* Debug Log Box */
        #debugLog { background:#1a1c1e; color:#0f0; font-family:monospace; font-size:10px; padding:10px; margin-bottom:10px; border-radius:8px; max-height:120px; overflow-y:auto; border:1px solid #333; }
        
        header { display: flex; flex-direction: column; gap: 8px; padding: 12px 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        #tokenBox { display: none; font-size: 10px; background: #f0f4f9; border: 1px dashed var(--md-outline); padding: 10px; border-radius: 12px; word-break: break-all; margin-bottom: 10px; color: var(--md-primary); }
        .btn-icon { background: none; border: none; color: var(--md-outline); cursor: pointer; padding: 8px; }
        .save-btn { background: var(--md-primary); color: white; border: none; width: 100%; height: 56px; border-radius: 28px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    </style>
</head>
<body>

<div id="debugLog"><div>-- System Logs --</div></div>

<header>
    <div class="header-top">
        <h1>ProTask Elite</h1>
        <div style="display:flex; gap: 4px;">
            <button class="btn-icon" onclick="testLocalPush()" title="Test Local Notification">
                <span class="material-symbols-outlined" style="color:var(--md-primary)">send_time_extension</span>
            </button>
            <button class="btn-icon" onclick="initNotifications()" id="bellBtn">
                <span class="material-symbols-outlined">notifications</span>
            </button>
            <button class="btn-icon" onclick="fullReset()">
                <span class="material-symbols-outlined" style="color:var(--md-error)">delete_forever</span>
            </button>
        </div>
    </div>
    <div id="tokenBox">Getting phone key...</div>
</header>

<div id="list"></div>

<script>
    function logDebug(msg) {
        const log = document.getElementById('debugLog');
        const entry = document.createElement('div');
        entry.innerText = `> ${new Date().toLocaleTimeString()}: ${msg}`;
        log.prepend(entry);
    }

    const firebaseConfig = {
        apiKey: "AIzaSyB1u-t7oQLWDg333noZcmtscbOo8fftPYE",
        authDomain: "protask-97ac8.firebaseapp.com",
        projectId: "protask-97ac8",
        storageBucket: "protask-97ac8.firebasestorage.app",
        messagingSenderId: "18921043127",
        appId: "1:18921043127:web:7780ee8e5b7ce919684932"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // Register Service Worker 
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(() => logDebug("SW Registered Successfully"))
            .catch(e => logDebug("SW Registration Failed: " + e.message));
    }

    // 1. Local Push Test (Blue Icon) 
    function testLocalPush() {
        logDebug("Triggering Local Test...");
        if (Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification("Local Test", { 
                    body: "If you see this, your phone allows notifications!",
                    icon: 'https://cdn-icons-png.flaticon.com/512/906/906334.png'
                });
                logDebug("Local push sent to system.");
            });
        } else {
            logDebug("Error: Notification permission not granted.");
            initNotifications();
        }
    }

    // 2. Firebase Bell Icon Logic 
    function initNotifications() {
        logDebug("Requesting Notification Permission...");
        Notification.requestPermission().then(permission => {
            logDebug("Permission: " + permission);
            if (permission === "granted") {
                navigator.serviceWorker.ready.then(reg => {
                    logDebug("Fetching Firebase Token...");
                    messaging.getToken({ 
                        vapidKey: 'BCVagHMWKomUbaoQdNy-vHYAhl22WsRT9jg-dKabIgtCWQaFVJN966m6wYMPrM0v8y3T5Khk6XmCkv5YDz4vxKI',
                        serviceWorkerRegistration: reg 
                    })
                    .then(token => {
                        if (token) {
                            logDebug("Token Received!");
                            document.getElementById('tokenBox').style.display = 'block';
                            document.getElementById('tokenBox').innerText = "MOBILE KEY: " + token;
                        }
                    }).catch(e => logDebug("Token Error: " + e.message));
                });
            }
        });
    }

    function fullReset() { if(confirm("Clear all?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>